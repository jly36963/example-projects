# go-pg

## todo

- don't eager fetch related data

## install

```bash
go get github.com/go-pg/migrations/v8
go get github.com/go-pg/pg/v10
go get github.com/joho/godotenv
go get "github.com/jinzhu/copier"
```

## startup

```bash
# run
make run
# build / run
make build; make run-build
```

## create migration

### naming

- create file in migrations directory
- name file like `<date>_<my_migration_name>`

### new migration template

```go
package main

import (
	"fmt"
	"github.com/go-pg/migrations/v8"
)

func init() {
	migrations.MustRegisterTx(up, down)
}

func up(db migrations.DB) error {
	// up logic
}

func down(db migrations.DB) error {
	// down logic
}
```

## initial setup

- run `make gqlgen-init` in app root directory.
- write `schema.graphql` file
  - use graphql syntax
- update gqlgen.yml to reflect change
  - change `schema` from `graph/*.graphqls` to `graph/*.graphql`
  - other changes?
- get rid of server.go (generated by gqlgen init)
  - this is meant for a standalone implementation
- create router.go with graphql handlers
  - this allows gin to use graphql server as a subrouter
- add `//go:generate go run github.com/99designs/gqlgen` to resolver.go
  - between package and import lines
- write logic in resolver.go
- try to generate
  - fails, but still creates generated code and works??

## example queries

### hello

```graphql
query Hello {
  hello
}
```

### insert ninja

```gql
mutation InsertNinja($ninja: NinjaNew!) {
  insertNinja(ninja: $ninja) {
    id
    first_name
    last_name
  }
}
```

```json
{
  "ninja": {
    "first_name": "Kakashi",
    "last_name": "Hatake"
  }
}
```

### update ninja

```gql
mutation UpdateNinja($id: ID!, $updates: NinjaUpdates!) {
  updateNinja(id: $id, updates: $updates) {
    id
    first_name
    last_name
  }
}
```

```json
{
  "id": 1,
  "updates": {
    "first_name": "Kaka",
    "last_name": "Sensei"
  }
}
```

### delete ninja

```gql
mutation DeleteNinja($id: ID!) {
  deleteNinja(id: $id) {
    id
    first_name
    last_name
  }
}
```

```json
{
  "id": 1
}
```

### insert jutsu

```gql
mutation InsertJutsu($jutsu: JutsuNew!) {
  insertJutsu(jutsu: $jutsu) {
    id
    name
    chakra_nature
    description
  }
}
```

```json
{
  "jutsu": {
    "name": "chidori",
    "chakra_nature": "lightning",
    "description": "lightning blade"
  }
}
```

### update jutsu

```gql
mutation UpdateJutsu($id: ID!, $updates: JutsuUpdates!) {
  updateJutsu(id: $id, updates: $updates) {
    id
    name
    chakra_nature
    description
  }
}
```

```json
{
  "id": 1,
  "updates": {
    "name": "Chidori",
    "chakra_nature": "Lightning",
    "description": "Lightning Blade"
  }
}
```

### delete jutsu

```gql
mutation DeleteJutsu($id: ID!) {
  deleteJutsu(id: $id) {
    id
    name
    chakra_nature
    description
  }
}
```

```json
{
  "id": 1
}
```

### add known jutsu (relation)

```gql
mutation AddKnownJutsu($ninja_id: ID!, $jutsu_id: ID!) {
  addKnownJutsu(ninja_id: $ninja_id, jutsu_id: $jutsu_id) {
    id
    first_name
    last_name
    jutsus {
      id
      name
      chakra_nature
      description
    }
  }
}
```

```json
{
  "ninja_id": 1,
  "jutsu_id": 1
}
```

### get ninja with known jutsu

```gql
query Ninja($id: ID!) {
  ninja(id: $id) {
    id
    first_name
    last_name
    jutsus {
      id
      name
      chakra_nature
      description
    }
  }
}
```

```json
{
  "id": 1
}
```
